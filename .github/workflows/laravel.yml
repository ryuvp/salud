name: Deploy to Production

on:
  push:
    branches:
      - main  # Se ejecutará cuando haya un push en la rama main

jobs:
  build:
    runs-on: ubuntu-latest  # Utilizamos un runner de GitHub con Ubuntu

    steps:
    - name: Checkout code
      uses: actions/checkout@v3  # Extrae el código del repositorio

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'  # Configura PHP 8.1 (puedes ajustarlo si es necesario)
        extensions: mbstring, bcmath, curl, zip, gd  # Extensiones necesarias para Laravel

    - name: Set up Node.js 20.12.2
      uses: actions/setup-node@v3
      with:
        node-version: '20.12.2'  # Configura Node.js 20.12.2

    - name: Install Composer dependencies
      run: |
        curl -sS https://getcomposer.org/installer | php
        php composer.phar install --no-dev --optimize-autoloader  # Instala dependencias sin las de desarrollo

    - name: Install npm dependencies and build assets
      run: |
        npm install
        npm run build  # Compila los activos de Laravel con Vite o Mix

    - name: Deploy to Server
      env:
        HOST: ${{ secrets.SERVER_HOST }}  # Dirección del servidor
        USER: ${{ secrets.SERVER_USER }}  # Usuario SSH en el servidor
        KEY: ${{ secrets.DEPLOY_SSH_KEY }}  # Clave SSH almacenada en los secrets de GitHub
      run: |
        echo "$KEY" > private_key.pem  # Crea un archivo de clave privada temporal
        chmod 600 private_key.pem
        rsync -avz --delete --exclude='.git*' --exclude='node_modules' -e "ssh -i private_key.pem -o StrictHostKeyChecking=no" ./ $USER@$HOST:/var/www/renopac  # Sincroniza los archivos con el servidor

    - name: Clear temporary private key
      run: rm -f private_key.pem  # Borra la clave privada temporal

